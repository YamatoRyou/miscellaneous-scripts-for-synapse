> [!CAUTION]
> # 警告
> ### 这些脚本仅在群晖 DSM 6.2.3 (Linux 3.10.105 x64) 上运行通过, 并且高度定制化 (含有高危命令与一些不适合在你的环境下调用的硬编码的内容). 除非你能充分理解其内容并有能力做出修改, 否则不要在你的服务器上执行这些脚本!
> ### 公开这些脚本仅用于思路分享, 并且作者不会为仓库中的现有脚本与修改后的脚本提供任何支持. 修改并使用即代表你接受此策略. 


# 关于此仓库
### 此仓库存储一些 Shell 脚本, 用于满足 Synapse 在运行期间的某些特定需求 (目前主要关注用户对媒体的上传或下载行为).

# 脚本运行时要求
- Synapse 在 Docker 中运行;
- 1 个用于 Synapse 的 nginx 反向代理, 并且 nginx 在 Docker 中运行;
- nginx 需要额外配置以启用 `ngx_http_limit_req_module` 模块;
- 脚本完全依赖 Synapse 的容器日志, 请确保日志级别为 DEBUG;
- 脚本依赖 在 Docker 中运行的 Postgres 并用于状态与数据存储;
- 脚本依赖 `jq` 命令以解析 JSON;
- 脚本依赖 `timeout` 命令以监控进程 ID;
- 脚本依赖 `openssl` 命令以生成随机数;
- 脚本依赖在 Docker 中运行的 ntfy, 用于服务器外通知;
- 脚本依赖的 Shell 为 ash.

# 脚本做了什么?
- **脚本在初始化时会创建一个大小为 1 MB 的 Ramdisk 用于存储临时文件.**
- 一个 Synapse 实例下用户在上传媒体 (文件) 时会发生各种情况, 脚本会根据不同的情况做出不同的反应:
  - 如果用户上传了 1 个文件:
    - 如果上传的文件大于 5 MB, 则脚本向上传者发送通知;
    - 如果上传的文件小于等于 5 MB, 则脚本不会向上传者发送通知
  - 如果用户上传了多个文件:
    - 如果上传的文件数量小于等于 10 个:
      - 这些文件中只有大于 5 MB 才会向上传者发送通知, 小于等于 5 MB 的被跳过;
    - 如果上传的文件数量大于 10 个:
      - (需要额外配置反向代理) 反向代理会阻断部分文件的上传请求, 并向上传者发送通知;
      - 根据用户 ID 区分, 在 1 秒内产生的所有上传请求仅通知 1 次.
    - 如果用户的上传流量配额耗尽或不足的情况下上传文件:
      - 脚本向上传者发送通知, 并删除上传的文件;
  - 如果用户下载了 1 个文件:
    - 如果文件存在:
      - 如果下载的文件小于等于 5 MB, 则脚本不会向下载者发送通知;
      - 如果下载的文件大于 5 MB, 则脚本向下载者发送通知;
      - 根据文件的 MXC ID 区分, 通知的冷却时间为 30 分钟. 即同一个文件在 30 分钟内的多次下载仅通知 1 次.
    - 如果文件不存在:
      - 则脚本向下载者发送通知;
      - 根据文件的 MXC ID 区分, 通知的冷却时间为 5 分钟. 即同一个文件在 5 分钟内的多次下载仅通知 1 次.
- Synapse 检测到无法请求 `https://matrix.org/_matrix/push/v1/notify` 时使用 ntfy 在服务器外发出警报.

# 脚本原理
- 脚本的工作模式具有多进程; 并发; 异步的特征, 监控同一个 Docker 容器中含有不同关键词的日志, 并以此执行不同的行为. 某些脚本还会使用命名管道协同工作.
